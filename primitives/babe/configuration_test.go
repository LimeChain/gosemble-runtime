package babe

import (
	"bytes"
	"testing"

	sc "github.com/LimeChain/goscale"
	primitives "github.com/LimeChain/gosemble/primitives/types"
	"github.com/stretchr/testify/assert"
)

var (
	pubKey1 = primitives.Sr25519PublicKey{FixedSequence: sc.NewFixedSequence[sc.U8](32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)}

	authority = primitives.Authority{
		Id:     primitives.AccountId(pubKey1),
		Weight: sc.U64(2),
	}

	configuration = Configuration{
		SlotDuration: sc.U64(1),
		EpochLength:  sc.U64(2),
		C:            primitives.Tuple2U64{First: 3, Second: 4},
		Authorities:  sc.Sequence[primitives.Authority]{authority},
		Randomness:   NewRandomness(),
		AllowedSlots: NewPrimarySlots(),
	}
)

var (
	configurationBytes = []byte{
		0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
		0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
		0x3, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
		0x4, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
		0x4, 0x0,
		0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
		0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
		0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
		0x0,
	}
)

func Test_Configuration_Encode(t *testing.T) {
	buffer := &bytes.Buffer{}

	err := configuration.Encode(buffer)

	assert.NoError(t, err)
	assert.Equal(t, configurationBytes, buffer.Bytes())
}

func Test_Configuration_Bytes(t *testing.T) {
	assert.Equal(t, configurationBytes, configuration.Bytes())
}

func Test_DecodeConfiguration(t *testing.T) {
	buffer := bytes.NewBuffer(configurationBytes)

	decodedConfiguration, err := DecodeConfiguration(buffer)

	assert.NoError(t, err)
	assert.Equal(t, configuration, decodedConfiguration)
}
